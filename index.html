<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
  <script src="dist/container.js"></script>
  <script src="dist/engine.js"></script>
</head>
<body>
  <h1>Super-duper DTM Tester</h1>
  <p><a href="file.zip">Download link</a></p>
  <button id="clearBeaconAnalysisButton" onclick="clearBeaconAnalysis()">Clear Beacon Analysis</button>
  <!--<label><input id="frameworkEnabledCheckbox" type="checkbox" checked>Framework Enabled</label>-->
  <div id="hero" class="mboxDefault">Default offer</div>
  <button class="dataElementButton">Alert Data Element Value</button>
  <button class="trackFBConversionButton">Track Facebook conversion</button>
  <button class="trackFBEventButton">Track Facebook custom event</button>

  <script type="text/javascript">_satellite.pageBottom();</script>
  <script>
    var deserializeQuery = function(url) {
      var qIndex = url.indexOf('?');

      if (qIndex !== -1) {
        url = url.substr(qIndex + 1);
      }

      var deserialized = {};
      var paramSets = url.split('&');

      paramSets.forEach(function(paramSet) {
        if (paramSet.length) {
          var keyValue = paramSet.split('=');
          deserialized[keyValue[0]] = keyValue[1];
        }
      });

      return deserialized;
    };

    var ignoreParamExistentialDiff = [
      'fid', // Fallback visitor ID generated by AppMeasurement if no visitor ID acquired.
      'AQB', // Unknown Audience Manager stuff
      'AQE', // Unknown Audience Manager stuff
      'ndh', // Unknown Audience Manager stuff
      'pf', // Unknown Audience Manager stuff
      'pid', // For ClickMap
      'pidt', // For ClickMap
      'oid', // For ClickMap
      'oidt', // For ClickMap
      'ot' // For ClickMap
    ];

    var ignoreParamValueDiff = [
      't' // The timestamps between requests will be different because...well...they happened at different times.
    ];

    var analyze = function() {
      var dtmUrl = sessionStorage.getItem('dtmUrl');
      var amUrl = sessionStorage.getItem('amUrl');

      if (dtmUrl && amUrl) {
        var dtmParams = deserializeQuery(dtmUrl);
        var amParams = deserializeQuery(amUrl);

        var extraDTMParams = [];
        var extraAMParams = [];
        var paramsExistingInBoth = [];
        var paramsWithDifferentValues = [];
        var key;

        for (key in dtmParams) {
          if (ignoreParamExistentialDiff.indexOf(key) !== -1) {
            continue;
          }

          if (amParams.hasOwnProperty(key)) {
            paramsExistingInBoth.push(key);
          } else {
            extraDTMParams.push(key);
          }
        }

        for (key in amParams) {
          if (ignoreParamExistentialDiff.indexOf(key) !== -1) {
            continue;
          }

          if (!dtmParams.hasOwnProperty(key)) {
            extraAMParams.push(key);
          }
        }

        paramsExistingInBoth.forEach(function(key) {
          if (ignoreParamValueDiff.indexOf(key) === -1 && dtmParams[key] !== amParams[key]) {
            paramsWithDifferentValues.push(key);
          }
        });

        console.log('---- BEGIN BEACON ANALYSIS ----');

        console.log('DTM: ' + dtmUrl);
        console.log('AM: ' + amUrl);

        if (extraDTMParams.length) {
          console.log('Params found in DTM not found in AM: ' + extraDTMParams.join(', '));
        }

        if (extraAMParams.length) {
          console.log('Params found in AM not found in DTM: ' + extraAMParams.join(', '));
        }

        if (paramsWithDifferentValues.length) {
          console.log('Unequal parameter values:');
          paramsWithDifferentValues.forEach(function(key) {
            console.log('  ' + key);
            console.log('    DTM: ' + dtmParams[key]);
            console.log('    AM: ' + amParams[key]);
          });
        }

        if (ignoreParamExistentialDiff.length) {
          console.log('Ignored param existential differences: ' + ignoreParamExistentialDiff.join(', '));
        }

        if (ignoreParamValueDiff.length) {
          console.log('Ignored param value differences: ' + ignoreParamValueDiff.join(', '));
        }

        if (extraDTMParams.length === 0 &&
            extraAMParams.length === 0 &&
            paramsWithDifferentValues.length === 0) {
          console.log('Success! No differences found!');
        }

        console.log('---- END BEACON ANALYSIS ----');
      }
    };

    var recordAMUrl = function(url) {
      sessionStorage.setItem('amUrl', url);
      console.log('Recorded AppMeasurement URL', url);
      analyze();
    };

    var recordDTMUrl = function(url) {
      sessionStorage.setItem('dtmUrl', url);
      console.log('Recorded DTM URL', url);
      analyze();
    };

    var clearBeaconAnalysis = function() {
      sessionStorage.removeItem('amUrl');
      sessionStorage.removeItem('dtmUrl');
    }

    var clearBeaconAnalysisButton = document.querySelector('#clearBeaconAnalysisButton');
    var frameworkEnabledCheckbox = document.querySelector('#frameworkEnabledCheckbox');


    clearBeaconAnalysisButton.addEventListener('click', clearBeaconAnalysis);
//    frameworkEnabledCheckbox.addEventListener('change', function(event) {
//          window.frameworkEnabled = event.target.checked;
//          sessionStorage.setItem('frameworkEnabled', window.frameworkEnabled);
//        });

    window.frameworkEnabled = sessionStorage.getItem('frameworkEnabled') === 'true';

//    if (window.frameworkEnabled) {
//      frameworkEnabledCheckbox.setAttribute('checked', '');
//    } else {
//      frameworkEnabledCheckbox.removeAttribute('checked');
//    }
  </script>
</body>
</html>
